---
title: "AllYears_PP_Narr_Analysis"
author: "Kristen Johnson"
date: "2025-04-24"
output:
  pdf_document: default
  html_document: default
---
# Setup
##Load in packages
```{r, echo=FALSE}
# install necessary packages
#install.packages("DiagrammeR")
# Install if you don't have these
#install.packages(c("interactions", "lmboot"))


# Load required packages
library(tidyverse)
library(car)       # For regression diagnostics
library(lmtest)    # For regression diagnostics
library(effectsize) # For effect sizes
library(ggplot2)   # For visualization
library(here)
library(dplyr)
library(lme4)
library(lmerTest)
library(extrafont)
library(broom)
library(gt)
library(ggeffects)
library(DiagrammeR)
library(interactions) # for simple slopes
library(boot)         # for bootstrapping
library(lmboot)       # optional for robust bootstrapped SEs

```

## Read in each dataset and add Year column
```{r}
completely_merged_data_H10 <- read_csv(here("PN_DataAnalysis", "PP_Narrative_Analysis", "completely_merged_data_H10.csv"))
completely_merged_data_H10$Year <- 10

completely_merged_data_H8 <- read_csv(here("PN_DataAnalysis", "PP_Narrative_Analysis", "completely_merged_data_H8.csv"))
completely_merged_data_H8$Year <- 8

completely_merged_data_H7 <- read_csv(here("PN_DataAnalysis", "PP_Narrative_Analysis", "completely_merged_data_H7.csv"))
completely_merged_data_H7$Year <- 7
```

## Combine data across ALL THREE YEARS
```{r}
# Combine all datasets into one data frame
completely_merged_data_ALLyears <- bind_rows(completely_merged_data_H10, completely_merged_data_H8, completely_merged_data_H7)

# View the combined dataset
head(completely_merged_data_ALLyears)

# write a csv
write_csv(completely_merged_data_ALLyears, here("PN_DataAnalysis", "PP_Narrative_Analysis","completely_merged_data_ALLyears.csv"))
```
#OLS regressions
## Linear regression Models 1 & 2 (mixed effects wouldn't work)- OLS
```{r}
model1_ols <- lm(max_avg ~ groupstatus + total_gestures + total_pretend_episodes + mlu + Year + groupstatus:total_gestures, 
             data = completely_merged_data_ALLyears)

# Model 2: Representational gesture presence as predictor
model2_ols <- lm(max_avg ~ groupstatus + rep_gesture_present + total_pretend_episodes + mlu + Year + groupstatus:rep_gesture_present, 
             data = completely_merged_data_ALLyears)

summary(model1_ols)
summary(model2_ols)

# Calculate effect sizes
eta_squared(model1_ols)
eta_squared(model2_ols)
```

## Combined regression table (OLS) of Model 1 and Model 2 
```{r}
library(broom)
library(dplyr)
library(gt)

# Step 1: Tidy and format original OLS models

# Model 1 (Total Gestures)
model1_ols_tidy <- tidy(model1_ols) %>%
  mutate(
    Predictor = case_when(
      term == "(Intercept)" ~ "Intercept",
      term == "groupstatusTD" ~ "Group Status (TD vs PL)",
      term == "total_gestures" ~ "Total Gestures",
      term == "total_pretend_episodes" ~ "Total Pretend Episodes",
      term == "mlu" ~ "Mean Length of Utterance (MLU)",
      term == "groupstatusTD:total_gestures" ~ "Group × Total Gestures Interaction",
      TRUE ~ term
    )
  ) %>%
  select(Predictor, estimate, std.error, p.value)

# Model 2 (Gesture Presence)
model2_ols_tidy <- tidy(model2_ols) %>%
  mutate(
    Predictor = case_when(
      term == "(Intercept)" ~ "Intercept",
      term == "groupstatusTD" ~ "Group Status (TD vs PL)",
      term == "rep_gesture_present" ~ "Gesture Presence",
      term == "total_pretend_episodes" ~ "Total Pretend Episodes",
      term == "mlu" ~ "Mean Length of Utterance (MLU)",
      term == "groupstatusTD:rep_gesture_present" ~ "Group × Gesture Presence Interaction",
      TRUE ~ term
    )
  ) %>%
  select(Predictor, estimate, std.error, p.value)

# Step 2: Full join on Predictor
combined_ols_table <- full_join(model1_ols_tidy, model2_ols_tidy, by = "Predictor", suffix = c("_Model1", "_Model2")) %>%
  mutate(
    Sig1 = case_when(
      p.value_Model1 < .001 ~ "***",
      p.value_Model1 < .01 ~ "**",
      p.value_Model1 < .05 ~ "*",
      TRUE ~ ""
    ),
    Sig2 = case_when(
      p.value_Model2 < .001 ~ "***",
      p.value_Model2 < .01 ~ "**",
      p.value_Model2 < .05 ~ "*",
      TRUE ~ ""
    ),
    `b (Model 1)` = ifelse(!is.na(estimate_Model1), sprintf("%.2f", estimate_Model1), NA),
    `SE (Model 1)` = ifelse(!is.na(std.error_Model1), sprintf("%.2f", std.error_Model1), NA),
    `b (Model 2)` = ifelse(!is.na(estimate_Model2), sprintf("%.2f", estimate_Model2), NA),
    `SE (Model 2)` = ifelse(!is.na(std.error_Model2), sprintf("%.2f", std.error_Model2), NA),
    `b (Model 1)` = paste0(`b (Model 1)`, Sig1),
    `b (Model 2)` = paste0(`b (Model 2)`, Sig2)
  ) %>%
  select(Predictor, `b (Model 1)`, `SE (Model 1)`, `b (Model 2)`, `SE (Model 2)`, p.value_Model1, p.value_Model2)

# Step 3: Make the gt table
combined_ols_table %>%
  gt() %>%
  tab_header(
    title = "Table X",
    subtitle = "OLS Regression Predicting Narrative Structure Scores Across Models"
  ) %>%
  cols_label(
    Predictor = "Predictor",
    `b (Model 1)` = "b (Model 1)",
    `SE (Model 1)` = "SE (Model 1)",
    `b (Model 2)` = "b (Model 2)",
    `SE (Model 2)` = "SE (Model 2)"
  ) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_body(
      rows = (p.value_Model1 < 0.05) | (p.value_Model2 < 0.05),
      columns = c(`b (Model 1)`, `b (Model 2)`)
    )
  ) %>%
  cols_hide(columns = c(p.value_Model1, p.value_Model2)) %>%
  tab_options(
    table.font.size = "small",
    heading.align = "center",
    data_row.padding = px(2),
    column_labels.font.weight = "bold",
    table.width = pct(90)
  ) %>%
  tab_source_note(
    source_note = "Note. b = unstandardized regression coefficient; SE = standard error. *p* < .05, **p** < .01, ***p*** < .001."
  )

```

## APA combo table in docx
```{r}
library(flextable)
library(officer)
library(dplyr)
library(extrafont)

# Step 1: Identify rows to bold (based on presence of * in b columns)
bold_rows_model1 <- grep("\\*", combined_ols_table$`b (Model 1)`)
bold_rows_model2 <- grep("\\*", combined_ols_table$`b (Model 2)`)

# Step 2: Create flextable
ft <- combined_ols_table %>%
  select(Predictor, `b (Model 1)`, `SE (Model 1)`, `b (Model 2)`, `SE (Model 2)`) %>%
  flextable() %>%
  set_header_labels(
    Predictor = "Predictor",
    `b (Model 1)` = "b (Model 1)",
    `SE (Model 1)` = "SE (Model 1)",
    `b (Model 2)` = "b (Model 2)",
    `SE (Model 2)` = "SE (Model 2)"
  ) %>%
  fontsize(size = 11, part = "all") %>%
  font(fontname = "Times New Roman", part = "all") %>%
  bold(i = bold_rows_model1, j = "b (Model 1)") %>%
  bold(i = bold_rows_model2, j = "b (Model 2)") %>%
  autofit() %>%
  add_footer_lines("Note. b = unstandardized regression coefficient; SE = standard error. *p* < .05, **p** < .01, ***p*** < .001.")

# Step 3: Save to Word document
read_docx() %>%
  body_add_par("Table X. OLS Regression Predicting Narrative Structure Scores Across Models", style = "heading 2") %>%
  body_add_flextable(ft) %>%
  print(target = "OLS_Regression_Table.docx")

```


## Reduced Versions of Model 2 (OLS), dropping nonsignificant predictors
```{r}
# Lean version of Model 2: Representational gesture presence as predictor
model2_ols_lean <- lm(max_avg ~ groupstatus + rep_gesture_present + mlu + Year + groupstatus:rep_gesture_present, 
             data = completely_merged_data_ALLyears)

# Even leaner version of Model 2: dropping Year
model2_ols_lean_noyear <- lm(max_avg ~ groupstatus + rep_gesture_present + mlu + groupstatus:rep_gesture_present, 
             data = completely_merged_data_ALLyears)

summary(model2_ols_lean)
summary(model2_ols_lean_noyear)

# Calculate effect sizes
eta_squared(model2_ols_lean)
eta_squared(model2_ols_lean_noyear)
```

### APA Table of Reduced Model 2
```{r}
# Load necessary libraries
library(broom)
library(dplyr)
library(gt)

# Assuming your reduced model 2 is stored as 'model2_reduced'
# Example: 
# model2_reduced <- lm(max_avg ~ groupstatus + rep_gesture_present + mlu + groupstatus:rep_gesture_present, data = completely_merged_data_ALLyears)

# Step 1: Tidy the model output
model2_reduced_table <- tidy(model2_ols_lean_noyear) %>%
  mutate(
    sig = case_when(
      p.value < 0.001 ~ "***",
      p.value < 0.01 ~ "**",
      p.value < 0.05 ~ "*",
      p.value < 0.10 ~ "†",
      TRUE ~ ""
    ),
    b_formatted = sprintf("%.2f", estimate),
    SE_formatted = sprintf("%.2f", std.error),
    t_formatted = sprintf("%.2f", statistic),
    p_formatted = ifelse(p.value < .001, "< .001", sprintf("%.3f", p.value))
  ) %>%
  rename(
    Predictor = term
  ) %>%
  select(Predictor, b_formatted, SE_formatted, t_formatted, p_formatted, sig)

# Step 2: Create the APA-style gt table
model2_reduced_table %>%
  gt() %>%
  tab_header(
    title = "Table X",
    subtitle = "Reduced Linear Regression Predicting Narrative Structure Scores"
  ) %>%
  cols_label(
    Predictor = "Predictor",
    b_formatted = "b",
    SE_formatted = "SE",
    t_formatted = "t",
    p_formatted = "p",
    sig = ""
  ) %>%
  fmt_markdown(columns = vars(Predictor)) %>% 
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = cells_body(
      rows = sig != ""  # Bold significant rows
    )
  ) %>%
  tab_source_note(
    source_note = "Note. b = unstandardized regression coefficient; SE = standard error; t = t value; p = significance level. Significance indicated by * p < .05, ** p < .01, *** p < .001, † p < .10."
  ) %>%
  tab_options(
    table.font.size = "small",
    table.align = "center",
    data_row.padding = px(2)
  )

```

### APA table for docx
```{r}
library(flextable)
library(officer)
library(dplyr)

# Create flextable
ft <- model2_reduced_table %>%
  select(Predictor, b_formatted, SE_formatted, t_formatted, p_formatted, sig) %>%
  rename(
    `b` = b_formatted,
    `SE` = SE_formatted,
    `t` = t_formatted,
    `p` = p_formatted
  ) %>%
  flextable() %>%
  bold(i = ~ sig != "", bold = TRUE) %>%  # Bold rows with significance
  autofit() %>%
  fontsize(size = 11, part = "all") %>%
  font(fontname = "Times New Roman", part = "all") %>%
  set_table_properties(width = .8, layout = "autofit") %>%
  add_footer_lines(values = "Note. b = unstandardized regression coefficient; SE = standard error; t = t value; p = significance level. Significance indicated by * p < .05, ** p < .01, *** p < .001, † p < .10.")

# Create and save the Word doc
read_docx() %>%
  body_add_par("Table X. Reduced Linear Regression Predicting Narrative Structure Scores", style = "heading 2") %>%
  body_add_flextable(ft) %>%
  print(target = "Reduced_Model2_Table.docx")

```

### improved APA table for docx
```{r}
# Combine stars into the p column
model2_table_starred <- model2_reduced_table %>%
  mutate(
    # Combine p-value text with significance stars
    p_combined = case_when(
      p.value < 0.001 ~ "< .001***",
      p.value < 0.01  ~ paste0(sprintf("%.3f", p.value), "**"),
      p.value < 0.05  ~ paste0(sprintf("%.3f", p.value), "*"),
      p.value < 0.10  ~ paste0(sprintf("%.3f", p.value), "†"),
      TRUE            ~ sprintf("%.3f", p.value)
    )
  )

# Create APA-style flextable
ft <- model2_table_starred %>%
  select(Predictor, b_formatted, SE_formatted, t_formatted, p_combined) %>%
  rename(
    `b` = b_formatted,
    `SE` = SE_formatted,
    `t` = t_formatted,
    `p` = p_combined
  ) %>%
  flextable() %>%
  autofit() %>%
  fontsize(size = 11, part = "all") %>%
  font(fontname = "Times New Roman", part = "all") %>%
  set_table_properties(width = 0.8, layout = "autofit") %>%
  add_footer_lines(values = "Note. b = unstandardized regression coefficient; SE = standard error; t = t value; p = significance level. Significance indicated by * p < .05, ** p < .01, *** p < .001, † p < .10.")

b_with_stars = case_when(
  p.value < 0.001 ~ paste0(sprintf("%.2f", estimate), "***"),
  p.value < 0.01  ~ paste0(sprintf("%.2f", estimate), "**"),
  p.value < 0.05  ~ paste0(sprintf("%.2f", estimate), "*"),
  p.value < 0.10  ~ paste0(sprintf("%.2f", estimate), "†"),
  TRUE            ~ sprintf("%.2f", estimate)
)

read_docx() %>%
  body_add_par("Table X. Reduced Linear Regression Predicting Narrative Structure Scores", style = "heading 2") %>%
  body_add_flextable(ft) %>%
  print(target = "Reduced_Model2_Table_withStars.docx")

```


## Simple Slope of Predicted Outcomes for Model 2 (probs for appendix)
```{r}
library(ggeffects)

# Create the predicted data frame
effect_df <- ggpredict(model2_ols_lean_noyear, terms = c("rep_gesture_present", "groupstatus"))

# install.packages("extrafont")
library(extrafont)

# APA-style polished plot
ggplot(effect_df, aes(x = x, y = predicted, color = group)) +
  geom_point(size = 4) +
  geom_line(size = 1.5) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = group), alpha = 0.2, color = NA) +
  scale_color_manual(values = c("black", "gray40")) +
  scale_fill_manual(values = c("black", "gray40")) +
  labs(
    title = NULL,
    x = "Representational Gesture Presence",
    y = "Predicted Narrative Structure Score",
    color = "Group",
    fill = "Group"
  ) +
  theme_minimal(base_size = 14, base_family = "Times New Roman") +
  theme(
    legend.position = "bottom",
    plot.title = element_text(face = "bold", hjust = 0.5),
    axis.title = element_text(face = "bold"),
    panel.grid.major = element_line(color = "gray85"),
    panel.grid.minor = element_blank(),
    legend.title = element_blank()
  )

```
### save as png
```{r}
p <- ggplot(effect_df, aes(x = x, y = predicted, color = group)) +
  geom_point(size = 4) +
  geom_line(size = 1.5) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = group), alpha = 0.2, color = NA) +
  scale_color_manual(values = c("black", "gray40")) +
  scale_fill_manual(values = c("black", "gray40")) +
  labs(
    title = "Figure 4",
    subtitle = "Predicted Narrative Structure by Representational Gesture and Group",
    x = "Representational Gesture Presence",
    y = "Predicted Narrative Structure Score",
    color = "Group",
    fill = "Group"
  ) +
  theme_classic(base_size = 14, base_family = "Times New Roman") +
  theme(
    panel.background = element_rect(fill = "white", color = NA),
    plot.background = element_rect(fill = "white", color = NA),
    legend.position = "bottom",
    plot.title = element_text(face = "bold", hjust = 0.5, size = 12),
    plot.subtitle = element_text(hjust = 0.5, size = 12),
    axis.title = element_text(face = "bold"),
    legend.title = element_blank()
  )

# Save as PNG with white background
ggsave(
  filename = "Predicted_Narrative_by_Gesture_Group.png",
  plot = p,
  width = 6.5, height = 5, dpi = 300, units = "in", bg = "white"
)

#Fig. X Model-adjusted means controlling for MLU; shaded areas reflect 95% confidence intervals.
```


## APA Interaction Plot: Model 2's observed means and standard errors
```{r}
# Step 1: Summarize group means and standard errors
summary_data <- completely_merged_data_ALLyears %>%
  group_by(groupstatus, rep_gesture_present) %>%
  summarize(
    mean_score = mean(max_avg, na.rm = TRUE),
    se_score = sd(max_avg, na.rm = TRUE) / sqrt(n()),
    .groups = "drop"
  )

# Step 2: APA-style Plot without ribbons
ggplot() +
  
  # 2a: Individual participant points (optional jitter for transparency)
  geom_jitter(
    data = completely_merged_data_ALLyears,
    aes(x = factor(rep_gesture_present), y = max_avg, shape = groupstatus),
    width = 0.2, height = 0, alpha = 0.6, size = 2, color = "black"
  ) +
  
  # 2b: Vertical error bars (±1 SE)
  geom_errorbar(
    data = summary_data,
    aes(
      x = factor(rep_gesture_present),
      ymin = mean_score - se_score,
      ymax = mean_score + se_score,
      group = groupstatus
    ),
    width = 0.1,
    position = position_dodge(width = 0.3),
    color = "black",
    size = 0.8
  ) +
  
  # 2c: Mean points
  geom_point(
    data = summary_data,
    aes(x = factor(rep_gesture_present), y = mean_score, shape = groupstatus),
    position = position_dodge(width = 0.3),
    size = 3,
    color = "black",
    fill = "white"
  ) +
  
  # 2d: Connecting lines between group means
  geom_line(
    data = summary_data,
    aes(x = factor(rep_gesture_present), y = mean_score, group = groupstatus, linetype = groupstatus),
    position = position_dodge(width = 0.3),
    color = "black",
    size = 1
  ) +
  
  # 2e: Labels and APA-style theme
  scale_x_discrete(labels = c("No Gesture", "Gesture")) +
  
  # IMPORTANT: match PL = dashed/triangle, TD = solid/circle
  scale_shape_manual(values = c("PL" = 24, "TD" = 21)) +  # triangle = 24, circle = 21
  scale_linetype_manual(values = c("PL" = "dashed", "TD" = "solid")) +
  
  labs(
    title = "Interaction of Group Status and Representational Gesture",
    x = "Representational Gesture Presence",
    y = "Narrative Structure Score",
    shape = "Group Status",
    linetype = "Group Status"
  ) +
  
  theme_minimal(base_size = 14, base_family = "Times New Roman") +
  theme(
    panel.background = element_rect(fill = "white", color = NA),
    plot.background = element_rect(fill = "white", color = NA),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(color = "black", fill = NA),
    plot.title = element_text(hjust = 0.5, face = "bold"),
    axis.title = element_text(face = "bold"),
    axis.text = element_text(color = "black"),
    legend.position = "bottom",
    legend.title = element_text(face = "bold")
  )

# Figure X
#Observed mean narrative structure scores by group status and representational gesture presence during pretend play. Circles and solid lines represent typically developing (TD) children; triangles and dashed lines represent children with perinatal lesions (PL). Error bars indicate ±1 standard error of the mean. Children with PL demonstrated higher narrative structure scores when representational gestures were present, whereas typically developing children showed no corresponding benefit. This observed pattern parallels model-predicted results controlling for mean length of utterance (MLU).


##Figure X. Mean narrative structure scores by group and representational gesture presence. Solid and dashed lines represent typically developing children and children with perinatal lesions, respectively. Circle and triangle points denote mean scores at each level of representational gesture presence. Error bars represent ±1 standard error.

### Figure 2
# Interaction between group status and representational gesture presence predicting narrative structure scores. Solid and dashed lines represent typically developing children and children with perinatal lesions, respectively. Vertical error bars represent ±1 standard error of the mean.

```

###save as png
```{r}
# Create the plot object
p <- ggplot() +
  
  # Jittered individual points
  geom_jitter(
    data = completely_merged_data_ALLyears,
    aes(x = factor(rep_gesture_present), y = max_avg, shape = groupstatus),
    width = 0.2, height = 0, alpha = 0.6, size = 2, color = "black"
  ) +
  
  # Error bars
  geom_errorbar(
    data = summary_data,
    aes(
      x = factor(rep_gesture_present),
      ymin = mean_score - se_score,
      ymax = mean_score + se_score,
      group = groupstatus
    ),
    width = 0.1,
    position = position_dodge(width = 0.3),
    color = "black",
    size = 0.8
  ) +
  
  # Mean points
  geom_point(
    data = summary_data,
    aes(x = factor(rep_gesture_present), y = mean_score, shape = groupstatus),
    position = position_dodge(width = 0.3),
    size = 3,
    color = "black",
    fill = "white"
  ) +
  
  # Connecting lines
  geom_line(
    data = summary_data,
    aes(x = factor(rep_gesture_present), y = mean_score, group = groupstatus, linetype = groupstatus),
    position = position_dodge(width = 0.3),
    color = "black",
    size = 1
  ) +
  
  # Axes and aesthetics
  scale_x_discrete(labels = c("No Gesture", "Gesture")) +
  scale_shape_manual(values = c("PL" = 24, "TD" = 21)) +
  scale_linetype_manual(values = c("PL" = "dashed", "TD" = "solid")) +
  
  labs(
    title = "Figure 3",
    subtitle = "Interaction of Group Status and Representational Gesture",
    x = "Representational Gesture Presence",
    y = "Narrative Structure Score",
    shape = "Group Status",
    linetype = "Group Status"
  ) +
  
  theme_minimal(base_size = 14, base_family = "Times New Roman") +
  theme(
    panel.background = element_rect(fill = "white", color = NA),
    plot.background = element_rect(fill = "white", color = NA),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(color = "black", fill = NA),
    plot.title = element_text(hjust = 0.5, face = "bold"),
    axis.title = element_text(face = "bold"),
    axis.text = element_text(color = "black"),
    legend.position = "bottom",
    legend.title = element_text(face = "bold")
  )


ggsave(
  filename = "ObservedMeans_Gesture_Group_Interaction.png",
  plot = p,
  width = 6.5, height = 5, dpi = 300, units = "in",
  bg = "white"  # <- This ensures the PNG background is white
)
```



#ROBUST regressions
## Robust Regression for Model 1
```{r}
library(robustbase)

model1_robust <- lmrob(max_avg ~ groupstatus + total_gestures + total_pretend_episodes + mlu + groupstatus:total_gestures, 
                       data = completely_merged_data_ALLyears)

# View summary
summary(model1_robust)

```

### Table for Model 1 Robust Regression 
```{r}
library(broom)
library(dplyr)
library(gt)

# Step 1: Tidy and prepare the model1_robust
model1_robust_table <- tidy(model1_robust) %>%
  mutate(
    term = case_when(
      term == "(Intercept)" ~ "Intercept",
      term == "groupstatusPL" ~ "Group Status (PL vs TD)",
      term == "total_gestures" ~ "Total Gestures",
      term == "total_pretend_episodes" ~ "Total Pretend Episodes",
      term == "mlu" ~ "Mean Length of Utterance (MLU)",
      term == "groupstatusPL:total_gestures" ~ "Group × Total Gestures Interaction",
      TRUE ~ term
    ),
    estimate = sprintf("%.2f", estimate),  # Format b values
    std.error = sprintf("%.2f", std.error), # Format SE
    statistic = sprintf("%.2f", statistic), # Format t
    p.value = as.numeric(p.value)  # Keep numeric for sig flag
  ) %>%
  mutate(
    sig = ifelse(p.value < 0.05, TRUE, FALSE),  # Flag significance
    p.value = ifelse(p.value < .001, "< .001", sprintf("%.3f", p.value))  # Format p values
  )

# Step 2: Build the gt table with hidden sig column
model1_robust_table %>%
  select(Predictor = term, b = estimate, SE = std.error, t = statistic, p = p.value, sig) %>%
  gt() %>%
  tab_header(
    title = "Table X",
    subtitle = "Robust Regression Predicting Narrative Structure Scores (Model 1: Total Gestures)"
  ) %>%
  cols_label(
    Predictor = "Predictor",
    b = "b",
    SE = "SE",
    t = "t",
    p = "p"
  ) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_body(
      rows = sig == TRUE
    )
  ) %>%
  cols_hide(columns = sig) %>%
  tab_options(
    table.font.size = "small",
    heading.align = "center",
    data_row.padding = px(2),
    column_labels.font.weight = "bold",
    table.width = pct(80)
  ) %>%
  tab_source_note(
    source_note = "Note. b = unstandardized regression coefficient; SE = robust standard error; p = significance level. Significant predictors are bolded."
  )

```

## Robust Regression for Model 2
```{r}
# Load package
library(robustbase)

# Run a robust linear model (rlm)
model2_robust <- lmrob(max_avg ~ groupstatus * rep_gesture_present + total_pretend_episodes + mlu, 
                       data = completely_merged_data_ALLyears)

# View summary
summary(model2_robust)
```

### Table for Model 2 Robust Regression
```{r}

# Assuming the same `model2_table` as above
library(broom)
library(dplyr)
library(gt)

# Step 1: Tidy and prepare the model
model2_robust_table <- tidy(model2_robust) %>%
  mutate(
    term = case_when(
      term == "(Intercept)" ~ "Intercept",
      term == "groupstatusPL" ~ "Group Status (PL vs TD)",
      term == "rep_gesture_present" ~ "Representative Gesture",
      term == "total_pretend_episodes" ~ "Total Pretend Episodes",
      term == "mlu" ~ "Mean Length of Utterance (MLU)",
      term == "groupstatusPL:rep_gesture_present" ~ "Group × Representative Gesture Interaction",
      TRUE ~ term
    ),
    estimate = sprintf("%.2f", estimate),
    std.error = sprintf("%.2f", std.error),
    statistic = sprintf("%.2f", statistic),
    p.value = as.numeric(p.value)  # keep numeric for now
  ) %>%
  mutate(
    sig = ifelse(p.value < 0.05, TRUE, FALSE),  # Flag significance
    p.value = ifelse(p.value < .001, "< .001", sprintf("%.3f", p.value))  # Format p
  )

# Step 2: Build table — but select only the columns you want shown
model2_robust_table %>%
  select(Predictor = term, b = estimate, SE = std.error, t = statistic, p = p.value, sig) %>% # include sig temporarily
  gt() %>%
  tab_header(
    title = "Table X",
    subtitle = "Robust Regression Predicting Narrative Structure Scores"
  ) %>%
  cols_label(
    Predictor = "Predictor",
    b = "b",
    SE = "SE",
    t = "t",
    p = "p"
  ) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_body(
      rows = sig == TRUE
    )
  ) %>%
  cols_hide(columns = sig) %>%   # <<< THIS hides the sig column from printing
  tab_options(
    table.font.size = "small",
    heading.align = "center",
    data_row.padding = px(2),
    column_labels.font.weight = "bold",
    table.width = pct(80)
  ) %>%
  tab_source_note(
    source_note = "Note. b = unstandardized regression coefficient; SE = robust standard error; p = significance level. Significant predictors are bolded."
  )

```

## Robust Regression for Reduced Model 2 
```{r}
# Robust regression for reduced Model 2 (your final one)
model2_reduced_robust <- lmrob(max_avg ~ groupstatus + rep_gesture_present + mlu + groupstatus:rep_gesture_present, 
                               data = completely_merged_data_ALLyears)
summary(model2_reduced_robust)
```

### Comp. Table: OLS and Robust Regression for Model 2 (reduced) 
```{r}
# Load libraries
library(broom)
library(dplyr)

# Tidy the original OLS model
ols_table <- tidy(model2_ols_lean_noyear) %>%
  mutate(
    Model = "OLS",
    Estimate = round(estimate, 2),
    SE = round(std.error, 2),
    p = ifelse(p.value < .001, "< .001", sprintf("%.3f", p.value))
  ) %>%
  select(Model, term, Estimate, SE, p)

# Tidy the robust model
robust_table <- tidy(model2_reduced_robust) %>%
  mutate(
    Model = "Robust",
    Estimate = round(estimate, 2),
    SE = round(std.error, 2),
    p = ifelse(p.value < .001, "< .001", sprintf("%.3f", p.value))
  ) %>%
  select(Model, term, Estimate, SE, p)

# Combine
combined_table <- bind_rows(ols_table, robust_table) %>%
  arrange(term, Model)  # Keep terms together

# Load gt package
library(gt)

# Build the table
combined_table %>%
  rename(
    Predictor = term
  ) %>%
  gt(groupname_col = "Model") %>%
  tab_header(
    title = "Table X",
    subtitle = "Comparison of OLS and Robust Regression Estimates for Reduced Model 2"
  ) %>%
  cols_label(
    Predictor = "Predictor",
    Estimate = "b",
    SE = "SE",
    p = "p"
  ) %>%
  tab_options(
    table.font.size = "small",
    data_row.padding = px(2),
    table.align = "center"
  ) %>%
  tab_source_note(
    source_note = "Note. b = unstandardized regression coefficient; SE = standard error; p = significance level. Robust regression conducted using MM-estimation with bisquare psi function."
  )

```

#### docx apa version
```{r}
# Load libraries
library(broom)
library(dplyr)
library(flextable)
library(officer)

# Tidy the OLS model
ols_table <- tidy(model2_ols_lean_noyear) %>%
  mutate(
    Model = "OLS",
    Estimate = round(estimate, 2),
    SE = round(std.error, 2),
    p_star = case_when(
      p.value < 0.001 ~ "< .001***",
      p.value < 0.01  ~ paste0(sprintf("%.3f", p.value), "**"),
      p.value < 0.05  ~ paste0(sprintf("%.3f", p.value), "*"),
      p.value < 0.10  ~ paste0(sprintf("%.3f", p.value), "†"),
      TRUE ~ sprintf("%.3f", p.value)
    )
  ) %>%
  select(Model, term, Estimate, SE = std.error, p = p_star)

# Tidy the Robust model
robust_table <- tidy(model2_reduced_robust) %>%
  mutate(
    Model = "Robust",
    Estimate = round(estimate, 2),
    SE = round(std.error, 2),
    p_star = case_when(
      p.value < 0.001 ~ "< .001***",
      p.value < 0.01  ~ paste0(sprintf("%.3f", p.value), "**"),
      p.value < 0.05  ~ paste0(sprintf("%.3f", p.value), "*"),
      p.value < 0.10  ~ paste0(sprintf("%.3f", p.value), "†"),
      TRUE ~ sprintf("%.3f", p.value)
    )
  ) %>%
  select(Model, term, Estimate, SE = std.error, p = p_star)

# Combine and order
combined_table <- bind_rows(ols_table, robust_table) %>%
  rename(Predictor = term) %>%
  mutate(Model = factor(Model, levels = c("OLS", "Robust"))) %>%
  arrange(Model, Predictor)

# Create flextable
ft <- combined_table %>%
  flextable() %>%
  set_header_labels(
    Predictor = "Predictor",
    Estimate = "b",
    SE = "SE",
    p = "p"
  ) %>%
  fontsize(size = 11, part = "all") %>%
  font(fontname = "Times New Roman", part = "all") %>%
  autofit() %>%
  set_table_properties(width = 0.9, layout = "autofit") %>%
  add_footer_lines(
    values = "Note. b = unstandardized regression coefficient; SE = standard error; p = significance level. Significance indicated by *p* < .05 (*), **p** < .01 (**), ***p*** < .001 (***), †p < .10. Robust regression used MM-estimation with bisquare psi function."
  )

# Save to Word
read_docx() %>%
  body_add_par("Table X. Comparison of OLS and Robust Regression Estimates for Reduced Model 2", style = "heading 2") %>%
  body_add_flextable(ft) %>%
  print(target = "Comparison_OLS_Robust_Table_withStars.docx")


```

### Comb. Table: Models 1 & 2(og) 
```{r}
library(broom)
library(dplyr)
library(gt)

# Step 1: Tidy and prep each model separately
model1_robust_tidy <- tidy(model1_robust) %>%
  mutate(
    Predictor = case_when(
      term == "(Intercept)" ~ "Intercept",
      term == "groupstatusPL" ~ "Group Status (PL vs TD)",
      term == "total_gestures" ~ "Total Gestures",
      term == "total_pretend_episodes" ~ "Total Pretend Episodes",
      term == "mlu" ~ "Mean Length of Utterance (MLU)",
      term == "groupstatusPL:total_gestures" ~ "Group × Total Gestures Interaction",
      TRUE ~ term
    ),
    Model = "Model 1"
  ) %>%
  select(Predictor, estimate, std.error, p.value)

model2_robust_tidy <- tidy(model2_robust) %>%
  mutate(
    Predictor = case_when(
      term == "(Intercept)" ~ "Intercept",
      term == "groupstatusPL" ~ "Group Status (PL vs TD)",
      term == "rep_gesture_present" ~ "Representative Gesture",
      term == "total_pretend_episodes" ~ "Total Pretend Episodes",
      term == "mlu" ~ "Mean Length of Utterance (MLU)",
      term == "groupstatusPL:rep_gesture_present" ~ "Group × Representative Gesture Interaction",
      TRUE ~ term
    ),
    Model = "Model 2"
  ) %>%
  select(Predictor, estimate, std.error, p.value)

# Step 2: Full join based on predictor names
combined_robust_table <- full_join(model1_robust_tidy, model2_robust_tidy, by = "Predictor", suffix = c("_Model1", "_Model2")) %>%
  mutate(
    Sig1 = case_when(
      p.value_Model1 < .001 ~ "***",
      p.value_Model1 < .01 ~ "**",
      p.value_Model1 < .05 ~ "*",
      TRUE ~ ""
    ),
    Sig2 = case_when(
      p.value_Model2 < .001 ~ "***",
      p.value_Model2 < .01 ~ "**",
      p.value_Model2 < .05 ~ "*",
      TRUE ~ ""
    ),
    `b (Model 1)` = ifelse(!is.na(estimate_Model1), sprintf("%.2f", estimate_Model1), NA),
    `SE (Model 1)` = ifelse(!is.na(std.error_Model1), sprintf("%.2f", std.error_Model1), NA),
    `b (Model 2)` = ifelse(!is.na(estimate_Model2), sprintf("%.2f", estimate_Model2), NA),
    `SE (Model 2)` = ifelse(!is.na(std.error_Model2), sprintf("%.2f", std.error_Model2), NA),
    `b (Model 1)` = paste0(`b (Model 1)`, Sig1),
    `b (Model 2)` = paste0(`b (Model 2)`, Sig2)
  ) %>%
  select(Predictor, `b (Model 1)`, `SE (Model 1)`, `b (Model 2)`, `SE (Model 2)`, p.value_Model1, p.value_Model2)

# Step 3: Create the gt table
combined_robust_table %>%
  gt() %>%
  tab_header(
    title = "Table X",
    subtitle = "Robust Regression Predicting Narrative Structure Scores Across Models"
  ) %>%
  cols_label(
    Predictor = "Predictor",
    `b (Model 1)` = "b (Model 1)",
    `SE (Model 1)` = "SE (Model 1)",
    `b (Model 2)` = "b (Model 2)",
    `SE (Model 2)` = "SE (Model 2)"
  ) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_body(
      rows = (p.value_Model1 < 0.05) | (p.value_Model2 < 0.05),
      columns = c(`b (Model 1)`, `b (Model 2)`)
    )
  ) %>%
  cols_hide(columns = c(p.value_Model1, p.value_Model2)) %>%
  tab_options(
    table.font.size = "small",
    heading.align = "center",
    data_row.padding = px(2),
    column_labels.font.weight = "bold",
    table.width = pct(90)
  ) %>%
  tab_source_note(
    source_note = "Note. b = unstandardized regression coefficient; SE = robust standard error. *p* < .05, **p** < .01, ***p*** < .001."
  )

```

#### docx apa version
```{r}
# Load required libraries
library(broom)
library(dplyr)
library(flextable)
library(officer)

# Step 1: Tidy and label each model
model1_robust_tidy <- tidy(model1_robust) %>%
  mutate(
    Predictor = case_when(
      term == "(Intercept)" ~ "Intercept",
      term == "groupstatusPL" ~ "Group Status (PL vs TD)",
      term == "total_gestures" ~ "Total Gestures",
      term == "total_pretend_episodes" ~ "Total Pretend Episodes",
      term == "mlu" ~ "Mean Length of Utterance (MLU)",
      term == "groupstatusPL:total_gestures" ~ "Group × Total Gestures Interaction",
      TRUE ~ term
    )
  ) %>%
  mutate(Model = "Model 1") %>%
  select(Predictor, estimate, std.error, p.value, Model)

model2_robust_tidy <- tidy(model2_robust) %>%
  mutate(
    Predictor = case_when(
      term == "(Intercept)" ~ "Intercept",
      term == "groupstatusPL" ~ "Group Status (PL vs TD)",
      term == "rep_gesture_present" ~ "Representative Gesture",
      term == "total_pretend_episodes" ~ "Total Pretend Episodes",
      term == "mlu" ~ "Mean Length of Utterance (MLU)",
      term == "groupstatusPL:rep_gesture_present" ~ "Group × Representative Gesture Interaction",
      TRUE ~ term
    )
  ) %>%
  mutate(Model = "Model 2") %>%
  select(Predictor, estimate, std.error, p.value, Model)

# Step 2: Merge models by predictor
combined_robust_table <- full_join(model1_robust_tidy, model2_robust_tidy, by = "Predictor", suffix = c("_Model1", "_Model2")) %>%
  mutate(
    Sig1 = case_when(
      p.value_Model1 < .001 ~ "***",
      p.value_Model1 < .01 ~ "**",
      p.value_Model1 < .05 ~ "*",
      p.value_Model1 < .10 ~ "†",
      TRUE ~ ""
    ),
    Sig2 = case_when(
      p.value_Model2 < .001 ~ "***",
      p.value_Model2 < .01 ~ "**",
      p.value_Model2 < .05 ~ "*",
      p.value_Model2 < .10 ~ "†",
      TRUE ~ ""
    ),
    `b (Model 1)` = ifelse(!is.na(estimate_Model1), sprintf("%.2f", estimate_Model1), NA),
    `SE (Model 1)` = ifelse(!is.na(std.error_Model1), sprintf("%.2f", std.error_Model1), NA),
    `b (Model 2)` = ifelse(!is.na(estimate_Model2), sprintf("%.2f", estimate_Model2), NA),
    `SE (Model 2)` = ifelse(!is.na(std.error_Model2), sprintf("%.2f", std.error_Model2), NA),
    `b (Model 1)` = paste0(`b (Model 1)`, Sig1),
    `b (Model 2)` = paste0(`b (Model 2)`, Sig2)
  ) %>%
  select(Predictor, `b (Model 1)`, `SE (Model 1)`, `b (Model 2)`, `SE (Model 2)`)

# Step 3: Create APA-style flextable
ft <- flextable(combined_robust_table) %>%
  set_header_labels(
    Predictor = "Predictor",
    `b (Model 1)` = "b (Model 1)",
    `SE (Model 1)` = "SE (Model 1)",
    `b (Model 2)` = "b (Model 2)",
    `SE (Model 2)` = "SE (Model 2)"
  ) %>%
  fontsize(size = 11, part = "all") %>%
  font(fontname = "Times New Roman", part = "all") %>%
  autofit() %>%
  set_table_properties(width = 0.95, layout = "autofit") %>%
  add_footer_lines(
    values = "Note. b = unstandardized regression coefficient; SE = robust standard error. Significance indicated by *p* < .05 (*), **p** < .01 (**), ***p*** < .001, †p < .10."
  )

# Step 4: Export to Word
read_docx() %>%
  body_add_par("Table X. Robust Regression Predicting Narrative Structure Scores Across Models", style = "heading 2") %>%
  body_add_flextable(ft) %>%
  print(target = "Robust_Regression_Table_Model1_Model2.docx")

```

## Effect sizes for Robust Models 1 & 2(reduced)
```{r}
# For Model 1: Total Gestures
model1_reduced <- lmrob(max_avg ~ groupstatus + total_gestures + total_pretend_episodes + mlu, 
                        data = completely_merged_data_ALLyears)

r2_full_model1 <- summary(model1_robust)$r.squared
r2_reduced_model1 <- summary(model1_reduced)$r.squared

f2_model1 <- (r2_full_model1 - r2_reduced_model1) / (1 - r2_full_model1)
print(paste("Cohen's f² for Model 1 (Total Gestures):", round(f2_model1, 3)))


# For Model 2: Gesture Presence
model2_reduced <- lmrob(max_avg ~ groupstatus + rep_gesture_present + total_pretend_episodes + mlu, 
                        data = completely_merged_data_ALLyears)

r2_full_model2 <- summary(model2_robust)$r.squared
r2_reduced_model2 <- summary(model2_reduced)$r.squared

f2_model2 <- (r2_full_model2 - r2_reduced_model2) / (1 - r2_full_model2)
print(paste("Cohen's f² for Model 2 (Gesture Presence):", round(f2_model2, 3)))

```

## MLU scatterplot
```{r}
# Load necessary libraries
library(ggplot2)
library(dplyr)

# Assume your data is called 'completely_merged_data_ALLyears'
# and it includes 'mlu', 'max_avg', and 'groupstatus'

# Make sure groupstatus is a factor if needed
completely_merged_data_ALLyears <- completely_merged_data_ALLyears %>%
  mutate(groupstatus = factor(groupstatus, levels = c("PL", "TD")))

# Create APA-style scatterplot
ggplot(completely_merged_data_ALLyears, aes(x = mlu, y = max_avg, group = groupstatus)) +
  
  # 1. Individual participant points
  geom_point(
    aes(shape = groupstatus),
    size = 3,
    color = "black",
    fill = "white"
  ) +
  
  # 2. Regression lines (separately for each group)
  geom_smooth(
    aes(linetype = groupstatus),
    method = "lm",
    se = TRUE,
    color = "black",
    size = 1
  ) +
  
  # 3. Manual scales for shapes and linetypes to match your other figures
  scale_shape_manual(values = c("PL" = 24, "TD" = 21)) +  # PL = triangle open, TD = circle open
  scale_linetype_manual(values = c("PL" = "dashed", "TD" = "solid")) +
  
  # 4. Labels
  labs(
    title = "Relationship Between MLU and Narrative Structure Score by Group",
    x = "Mean Length of Utterance (MLU)",
    y = "Narrative Structure Score",
    shape = "Group Status",
    linetype = "Group Status"
  ) +
  
  # 5. APA-style theming
  theme_minimal(base_size = 14, base_family = "Times New Roman") +
  theme(
    panel.background = element_rect(fill = "white", color = NA),
    plot.background = element_rect(fill = "white", color = NA),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(color = "black", fill = NA),
    plot.title = element_text(hjust = 0.5, face = "bold"),
    axis.title = element_text(face = "bold"),
    axis.text = element_text(color = "black"),
    legend.position = "bottom",
    legend.title = element_text(face = "bold")
  )

# Figure 2
#Scatterplot of narrative structure scores as a function of mean length of utterance (MLU), separated by group status. Triangles and dashed lines represent children with perinatal lesions (PL); circles and solid lines represent typically developing (TD) children. Shaded areas reflect 95% confidence intervals around regression lines.

```

# Text for Tables & Figures

## Tables' Notes

### For Table 1 (Main OLS Reduced Model):
Note.
b = unstandardized regression coefficient; SE = standard error; p = significance level. Partial eta-squared effect sizes are reported in-text.
p < .05. †p < .10.

### For Table A1 (OLS Model 1: Total Gestures):
Note.
b = unstandardized regression coefficient; SE = standard error; p = significance level. No significant predictors emerged.
p < .05. †p < .10.

### For Table A2 (Robust Model 1: Total Gestures):
Note.
Robust regression estimated using M-estimation with bisquare weighting. No significant predictors emerged.

### For Table A3 (Comparison of OLS and Robust for Reduced Model 2):
Note.
Comparison of ordinary least squares (OLS) and robust regression estimates for reduced Model 2.
Robust regression used M-estimation with bisquare weighting.
b = unstandardized regression coefficient; SE = standard error; p = significance level.
p < .05. †p < .10.


## Figures's Captions

### Figure 1 (Observed Means Plot: Group × Gesture Presence)
Figure 1
Observed mean narrative structure scores by group status and representational gesture presence. Triangles and dashed lines represent children with perinatal lesions (PL); circles and solid lines represent typically developing (TD) children. Error bars represent ±1 standard error of the mean.

### Figure 2 (MLU Scatterplot)
Figure 2
Scatterplot of narrative structure scores as a function of mean length of utterance (MLU), separated by group status. Triangles and dashed lines represent children with perinatal lesions (PL); circles and solid lines represent typically developing (TD) children. Shaded regions represent 95% confidence intervals around fitted regression lines."



# OLD CODE

## interaction plot
```{r, eval=FALSE}
library(ggplot2)

# Create a new variable to label group and rep_gesture_present combinations
completely_merged_data_ALLyears$group_rep <- interaction(
  completely_merged_data_ALLyears$groupstatus,
  completely_merged_data_ALLyears$rep_gesture_present,
  sep = " - GesturePresent: "
)

# Create the plot
ggplot(completely_merged_data_ALLyears, aes(x = rep_gesture_present, y = max_avg, color = groupstatus)) +
  stat_summary(fun = mean, geom = "point", position = position_dodge(width = 0.3)) +
  stat_summary(fun = mean, geom = "line", aes(group = groupstatus), position = position_dodge(width = 0.3)) +
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.1, position = position_dodge(width = 0.3)) +
  labs(
    title = "Interaction: Group × Representational Gesture Presence",
    x = "Representational Gesture Present (0 = No, 1 = Yes)",
    y = "Mean Narrative Structure Score",
    color = "Group Status"
  ) +
  theme_minimal(base_size = 14)

```

## scatterplot and facets
```{r, eval=FALSE}
library(ggplot2)

ggplot(completely_merged_data_ALLyears, aes(x = rep_gesture_present, y = max_avg, color = groupstatus)) +
  geom_jitter(width = 0.2, height = 0, size = 2, alpha = 0.8) +
  facet_wrap(~ groupstatus) +
  labs(
    title = "Narrative Structure Scores by Gesture Presence and Group",
    x = "Representational Gesture Present (0 = No, 1 = Yes)",
    y = "Narrative Structure Score"
  ) +
  theme_minimal(base_size = 14)

```

## APA style plot of group × gesture interaction slopes 
```{r, eval=FALSE}
library(ggplot2)
library(dplyr)

# Create a summary dataset first (means and standard errors)
summary_data <- completely_merged_data_ALLyears %>%
  group_by(groupstatus, rep_gesture_present) %>%
  summarize(
    mean_score = mean(max_avg, na.rm = TRUE),
    se_score = sd(max_avg, na.rm = TRUE) / sqrt(n())
  )

# Plot
ggplot(summary_data, aes(x = factor(rep_gesture_present), y = mean_score, group = groupstatus, color = groupstatus)) +
  geom_point(position = position_dodge(width = 0.3), size = 3) +
  geom_line(position = position_dodge(width = 0.3), aes(linetype = groupstatus)) +
  geom_errorbar(aes(ymin = mean_score - se_score, ymax = mean_score + se_score), 
                width = 0.1, position = position_dodge(width = 0.3)) +
  scale_x_discrete(labels = c("No Gesture", "Gesture Present")) +
  labs(
    title = "Interaction Between Group and Representational Gesture Presence",
    x = "Representational Gesture Presence",
    y = "Mean Narrative Structure Score",
    color = "Group Status",
    linetype = "Group Status"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "bottom",
    plot.title = element_text(hjust = 0.5)
  )

```

## with overlay of individuals
```{r, eval=FALSE}
library(ggplot2)
library(dplyr)

# Step 1: Summary dataset for group means and SE
summary_data <- completely_merged_data_ALLyears %>%
  group_by(groupstatus, rep_gesture_present) %>%
  summarize(
    mean_score = mean(max_avg, na.rm = TRUE),
    se_score = sd(max_avg, na.rm = TRUE) / sqrt(n()),
    .groups = "drop"
  )

# Step 2: Plot
ggplot() +
  # 2a: Individual participant points (light color)
  geom_jitter(
    data = completely_merged_data_ALLyears,
    aes(x = factor(rep_gesture_present), y = max_avg, color = groupstatus),
    width = 0.2, height = 0, alpha = 0.4, size = 2
  ) +
  
  # 2b: Group means (strong color)
  geom_point(
    data = summary_data,
    aes(x = factor(rep_gesture_present), y = mean_score, color = groupstatus),
    position = position_dodge(width = 0.3),
    size = 4
  ) +
  
  # 2c: Lines connecting group means
  geom_line(
    data = summary_data,
    aes(x = factor(rep_gesture_present), y = mean_score, group = groupstatus, color = groupstatus, linetype = groupstatus),
    position = position_dodge(width = 0.3)
  ) +
  
  # 2d: Error bars for means
  geom_errorbar(
    data = summary_data,
    aes(x = factor(rep_gesture_present), ymin = mean_score - se_score, ymax = mean_score + se_score, color = groupstatus),
    width = 0.1,
    position = position_dodge(width = 0.3)
  ) +
  
  # 2e: Labels and Themes
  scale_x_discrete(labels = c("No Gesture", "Gesture Present")) +
  labs(
    title = "Interaction of Group Status and Representational Gesture Presence",
    x = "Representational Gesture Presence",
    y = "Narrative Structure Score",
    color = "Group Status",
    linetype = "Group Status"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "bottom",
    plot.title = element_text(hjust = 0.5)
  )

```

## fancy graph
```{r, eval=FALSE}
# Summary dataset again
summary_data <- completely_merged_data_ALLyears %>%
  group_by(groupstatus, rep_gesture_present) %>%
  summarize(
    mean_score = mean(max_avg, na.rm = TRUE),
    se_score = sd(max_avg, na.rm = TRUE) / sqrt(n()),
    .groups = "drop"
  )

# Full plot with light gray background
ggplot() +
  # Individual points (light)
  geom_jitter(
    data = completely_merged_data_ALLyears,
    aes(x = factor(rep_gesture_present), y = max_avg, color = groupstatus),
    width = 0.2, height = 0, alpha = 0.4, size = 2
  ) +
  
  # Mean points (strong)
  geom_point(
    data = summary_data,
    aes(x = factor(rep_gesture_present), y = mean_score, color = groupstatus),
    position = position_dodge(width = 0.3),
    size = 4
  ) +
  
  # Lines between means
  geom_line(
    data = summary_data,
    aes(x = factor(rep_gesture_present), y = mean_score, group = groupstatus, color = groupstatus, linetype = groupstatus),
    position = position_dodge(width = 0.3)
  ) +
  
  # Error bars
  geom_errorbar(
    data = summary_data,
    aes(x = factor(rep_gesture_present), ymin = mean_score - se_score, ymax = mean_score + se_score, color = groupstatus),
    width = 0.1,
    position = position_dodge(width = 0.3)
  ) +
  
  # Labels
  scale_x_discrete(labels = c("No Gesture", "Gesture Present")) +
  labs(
    title = "Interaction of Group Status and Representational Gesture Presence",
    x = "Representational Gesture Presence",
    y = "Narrative Structure Score",
    color = "Group Status",
    linetype = "Group Status"
  ) +
  
  # Themes
  theme_minimal(base_size = 14) +
  theme(
    panel.background = element_rect(fill = "gray95", color = NA), # Light gray background
    plot.background = element_rect(fill = "white", color = NA),
    panel.grid.major = element_line(color = "gray90"),
    panel.grid.minor = element_blank(),
    legend.position = "bottom",
    plot.title = element_text(hjust = 0.5, face = "bold")
  )
```

## fancy graph 2" Interaction of Group Status and Representational Gesture Presence"
```{r, eval=FALSE}
# Step 1: Summarize group means and standard errors
summary_data <- completely_merged_data_ALLyears %>%
  group_by(groupstatus, rep_gesture_present) %>%
  summarize(
    mean_score = mean(max_avg, na.rm = TRUE),
    se_score = sd(max_avg, na.rm = TRUE) / sqrt(n()),
    .groups = "drop"
  )

# Step 2: Plot with ribbons
ggplot() +
  # 2a: Individual points (light gray dots)
  geom_jitter(
    data = completely_merged_data_ALLyears,
    aes(x = factor(rep_gesture_present), y = max_avg, color = groupstatus),
    width = 0.2, height = 0, alpha = 0.4, size = 2
  ) +
  
  # 2b: Ribbons for SE
  geom_ribbon(
    data = summary_data,
    aes(
      x = as.numeric(factor(rep_gesture_present)),
      ymin = mean_score - se_score,
      ymax = mean_score + se_score,
      fill = groupstatus,
      group = groupstatus
    ),
    inherit.aes = FALSE,
    alpha = 0.2
  ) +
  
  # 2c: Mean points
  geom_point(
    data = summary_data,
    aes(x = factor(rep_gesture_present), y = mean_score, color = groupstatus),
    position = position_dodge(width = 0.3),
    size = 4
  ) +
  
  # 2d: Lines connecting means
  geom_line(
    data = summary_data,
    aes(x = factor(rep_gesture_present), y = mean_score, group = groupstatus, color = groupstatus, linetype = groupstatus),
    position = position_dodge(width = 0.3)
  ) +
  
  # 2e: Labels and themes
  scale_x_discrete(labels = c("No Gesture", "Gesture Present")) +
  labs(
    title = "Interaction of Group Status and Representational Gesture Presence",
    x = "Representational Gesture Presence",
    y = "Narrative Structure Score",
    color = "Group Status",
    fill = "Group Status",
    linetype = "Group Status"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    panel.background = element_rect(fill = "gray95", color = NA),
    plot.background = element_rect(fill = "white", color = NA),
    panel.grid.major = element_line(color = "gray90"),
    panel.grid.minor = element_blank(),
    legend.position = "bottom",
    plot.title = element_text(hjust = 0.5, face = "bold")
  )

```

## APA figure of Simple Slope: Representational Gestures vs. Narrative Score
```{r, eval=FALSE}
# Step 1: Generate predicted values (simple slope for rep_gesture_present)
simple_slopes_rep_gesture <- ggpredict(
  model2,
  terms = c("rep_gesture_present", "groupstatus")  # Gesture presence (0/1) x Group
)

# Step 2: Build APA-style figure
ggplot(simple_slopes_rep_gesture, aes(x = x, y = predicted, group = group)) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = group),
              alpha = 0.1, color = NA) +
  geom_line(aes(linetype = group), color = "black", linewidth = 1.2) +
  geom_point(
    data = simple_slopes_rep_gesture %>%
      group_by(group) %>%
      filter(x == min(x) | x == max(x)),  # Only at 0 (No Gesture) and 1 (Gesture Present)
    aes(shape = group),
    size = 3,
    fill = "black",
    color = "black"
  ) +
  scale_x_continuous(
    breaks = c(0, 1),
    labels = c("No Gesture", "Gesture")
  ) +
  scale_linetype_manual(
    values = c("solid", "dashed")
  ) +
  scale_shape_manual(
    values = c(21, 24)  # circle and triangle
  ) +
  scale_fill_manual(
    values = c("gray70", "gray85")
  ) +
  labs(
    title = NULL,
    x = "Representational Gesture Presence",
    y = "Predicted Narrative Structure Score",
    linetype = "Group Status",
    shape = "Group Status",
    fill = "Group Status"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_rect(fill = "white", color = NA),
    plot.background = element_rect(fill = "white", color = NA),
    legend.position = "bottom",
    legend.title = element_text(face = "bold"),
    text = element_text(family = "Times New Roman"),
    axis.title = element_text(face = "bold"),
    axis.text = element_text(color = "black")
  )

#Figure X. Predicted narrative structure scores by group and representational gesture presence. Solid and dashed lines represent children with perinatal lesions and typically developing children, respectively. Circle and triangle points denote predicted narrative scores for absence and presence of representational gestures. Shaded regions represent 95% confidence intervals.
```

## APA simple slopes for total gestures & group status
```{r, eval=FALSE}
# Step 1: Generate predictions across a smooth range
simple_slopes_total_gestures <- ggpredict(
  model1,
  terms = c("total_gestures [0:100 by=1]", "groupstatus")
)

# Step 2: Build APA-Perfect figure
ggplot(simple_slopes_total_gestures, aes(x = x, y = predicted, group = group)) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = group), 
              alpha = 0.1, color = NA) +  # Light ribbons per group
  geom_line(aes(linetype = group), color = "black", linewidth = 1.2) +  # black solid/dashed
  geom_point(
    data = simple_slopes_total_gestures %>% 
      group_by(group) %>% 
      filter(x == min(x) | x == max(x)),  # Only mark start and end points
    aes(shape = group),
    size = 3,
    fill = "black",
    color = "black"
  ) +
  scale_linetype_manual(
    values = c("solid", "dashed")  # PL = solid, TD = dashed
  ) +
  scale_shape_manual(
    values = c(21, 24)  # Circle for one group, triangle for the other
  ) +
  scale_fill_manual(
    values = c("gray70", "gray85")
  ) +
  labs(
    title = NULL,
    x = "Total Gestures During Pretend Play",
    y = "Predicted Narrative Structure Score",
    linetype = "Group Status",
    shape = "Group Status",
    fill = "Group Status"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_rect(fill = "white", color = NA),
    plot.background = element_rect(fill = "white", color = NA),
    legend.position = "bottom",
    legend.title = element_text(face = "bold"),
    text = element_text(family = "Times New Roman"),
    axis.title = element_text(face = "bold"),
    axis.text = element_text(color = "black")
  )

#Figure X. Predicted narrative structure scores by group and total number of gestures during pretend play. Solid and dashed lines represent separate group slopes. Greater gesture use was associated with higher narrative structure scores for children with perinatal lesions, whereas this association was weaker among typically developing children. Shaded regions represent 95% confidence intervals.
```

## figure of Simple Slope: Representational Gestures vs. Narrative Score
```{r, eval=FALSE}
# Create sequence for representational gestures
rep_range <- seq(
  min(completely_merged_data_ALLyears$rep_gestures, na.rm = TRUE),
  max(completely_merged_data_ALLyears$rep_gestures, na.rm = TRUE),
  length.out = 100
)

# Build new prediction dataset
pred_data_rep <- data.frame(
  groupstatus = factor("PL", levels = c("PL", "TD")),  # match model factor
  total_gestures = mean(completely_merged_data_ALLyears$total_gestures, na.rm = TRUE),  # control for total gestures
  rep_gestures = rep_range,  # vary rep gestures across observed range
  mlu = mean(completely_merged_data_ALLyears$mlu, na.rm = TRUE),  # control for MLU
  total_pretend_episodes = mean(completely_merged_data_ALLyears$total_pretend_episodes, na.rm = TRUE),  # control
  Year = factor("7", levels = c("7", "8", "10"))  # hold year constant
)

# Predict narrative scores
pred_data_rep$predicted_narrative <- predict(model_fixed_effects, newdata = pred_data_rep)

# Plot
ggplot(completely_merged_data_ALLyears, aes(x = rep_gestures, y = max_avg)) +
  
  # Raw participant points
  geom_point(alpha = 0.6, color = "black", size = 2) +
  
  # Predicted regression line
  geom_line(data = pred_data_rep, aes(x = rep_gestures, y = predicted_narrative),
            color = "black", size = 1.2) +
  
  # Labels
  labs(
    title = "More representational gestures predict better narrative structure",
    x = "Number of representational gestures",
    y = "Narrative structure score"
  ) +
  
  # APA-style theme
  theme_minimal(base_size = 14, base_family = "Times New Roman") +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(color = "black", fill = NA, size = 0.8),
    axis.line = element_line(color = "black"),
    plot.title = element_text(hjust = 0.5, face = "bold"),
    axis.title = element_text(face = "bold"),
    legend.position = "none"
  )

```

```{r, eval=FALSE}
library(ggplot2)

ggplot(completely_merged_data_ALLyears, aes(x = rep_gestures, y = max_avg)) +
  
  # Raw participant points (still black dots)
  geom_point(alpha = 0.6, color = "black", size = 2) +
  
  # Participant IDs as text labels slightly above the dots
  geom_text(aes(label = participant_id), 
            vjust = -1,  # vertical adjustment above the point
            size = 3,    # size of text (adjustable)
            family = "Times New Roman") +
  
  # Predicted regression line
  geom_line(data = pred_data_rep, aes(x = rep_gestures, y = predicted_narrative),
            color = "black", size = 1.2) +
  
  # Labels
  labs(
    title = "More representational gestures predict better narrative structure",
    x = "Number of representational gestures",
    y = "Narrative structure score"
  ) +
  
  # APA-style minimal theme
  theme_minimal(base_size = 14, base_family = "Times New Roman") +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(color = "black", fill = NA, size = 0.8),
    axis.line = element_line(color = "black"),
    plot.title = element_text(hjust = 0.5, face = "bold"),
    axis.title = element_text(face = "bold"),
    legend.position = "none"
  )

```

## simple slope of Total Gestures vs. Narrative Score
```{r, eval=FALSE}
# Create a sequence of total gestures (z-scored)
gestures_range <- seq(
  min(completely_merged_data_ALLyears$total_gestures, na.rm = TRUE),
  max(completely_merged_data_ALLyears$total_gestures, na.rm = TRUE),
  length.out = 100
)

# Build prediction data
pred_data_total <- data.frame(
  groupstatus = factor("PL", levels = c("PL", "TD")),  # Hold group constant
  total_gestures = gestures_range,  # Vary total gestures
  rep_gestures = mean(completely_merged_data_ALLyears$rep_gestures, na.rm = TRUE),  # Hold rep gestures constant
  mlu_z = mean(completely_merged_data_ALLyears$mlu_z, na.rm = TRUE),  # Hold MLU constant
  total_pretend_episodes = mean(completely_merged_data_ALLyears$total_pretend_episodes, na.rm = TRUE),  # Hold pretend episodes constant
  Year = factor("7", levels = c("7", "8", "10"))  # Hold year constant
)

# Predict narrative scores
pred_data_total$predicted_narrative <- predict(model_fixed_effects, newdata = pred_data_total)

ggplot(completely_merged_data_ALLyears, aes(x = total_gestures, y = max_avg)) +
  
  # Raw participant points
  geom_point(alpha = 0.6, color = "black", size = 2) +
  
  # Predicted regression line
  geom_line(data = pred_data_total, aes(x = total_gestures, y = predicted_narrative),
            color = "black", size = 1.2) +
  
  # Labels
  labs(
    title = "Total gestures show marginal negative trend with narrative structure",
    x = "Total gestures during pretend play (z-scored)",
    y = "Narrative structure score"
  ) +
  
  # APA-style minimal theme
  theme_minimal(base_size = 14, base_family = "Times New Roman") +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(color = "black", fill = NA, size = 0.8),
    axis.line = element_line(color = "black"),
    plot.title = element_text(hjust = 0.5, face = "bold"),
    axis.title = element_text(face = "bold"),
    legend.position = "none"
  )

```

## Conceptual diagram of moderation model:
```{r, eval=FALSE}
library(DiagrammeR)

grViz("
digraph moderation_model {
  
  # General node style
  node [shape = rectangle, fontname = 'Times New Roman', fontsize = 14]

  # Nodes
  GesturePresence [label = 'Representational Gesture Presence']
  GroupStatus [label = 'Group Status (PL vs TD)']
  NarrativePL [label = 'Narrative Structure Score (PL)']
  NarrativeTD [label = 'Narrative Structure Score (TD)']

  # Solid Arrows (Main Effects)
  GesturePresence -> NarrativePL [label = 'Stronger Positive Effect', style = solid]
  GesturePresence -> NarrativeTD [label = 'Weaker Positive Effect', style = solid]

  # Dashed Arrows (Moderation)
  GroupStatus -> NarrativePL [label = 'Moderates', style = dashed]
  GroupStatus -> NarrativeTD [label = 'Moderates', style = dashed]
}
")

#Figure 3
#Conceptual model illustrating the moderating effect of group status (PL vs. TD) on the relationship between representational gesture presence and narrative structure outcomes. Solid arrows represent main effects, while dashed arrows represent moderation pathways. Gesture presence was more strongly associated with narrative quality for children with perinatal lesions compared to typically developing children.

```

## BOOTSTRAPPING!!! (...won't work)
```{r, eval=FALSE}
library(boot)          # For bootstrapping
library(interactions)  # For simple slopes and plotting

simple_slope_function <- function(data, indices) {
  d <- data[indices, ]  # Resample data
  tryCatch({
    # Refit YOUR model structure
    fit <- lm(max_avg ~ groupstatus + rep_gesture_present + total_pretend_episodes + mlu + groupstatus:rep_gesture_present, 
              data = d)
    
    # Extract coefficients
    coefs <- coef(fit)
    
    # Simple slope for PL (baseline group)
    slope_PL <- coefs["rep_gesture_present"]
    
    # Simple slope for TD (PL slope + interaction)
    slope_TD <- coefs["rep_gesture_present"] + coefs["groupstatusTD:rep_gesture_present"]
    
    return(c(slope_PL, slope_TD))
  }, error = function(e) {
    # If the model fails to fit, return NA
    return(c(NA, NA))
  })
}

set.seed(1234)

boot_results <- boot(
  data = completely_merged_data_ALLyears,
  statistic = simple_slope_function,
  R = 1000  # 1000 resamples
)

any(is.na(boot_results$t))  # TRUE if any NA slopes

# Clean if needed:
boot_clean <- boot_results
boot_clean$t <- boot_clean$t[complete.cases(boot_clean$t), ]

# For PL group (baseline)
boot.ci(boot_clean, type = "perc", index = 1)

# For TD group (interaction-adjusted)
boot.ci(boot_clean, type = "perc", index = 2)


```


## (FAILED) MIXED MODEL & TROUBLESHOOTING
```{r, eval=FALSE}
# Model 1: Total gestures as predictor
mixed_model1 <- lmer(max_avg ~ groupstatus + total_gestures + total_pretend_episodes + mlu + groupstatus:total_gestures + (1|participant_id), 
             data = completely_merged_data_ALLyears)

# Model 2: Representational gesture presence as predictor
mixed_model2 <- lmer(max_avg ~ groupstatus + rep_gesture_present + total_pretend_episodes + mlu + groupstatus:rep_gesture_present + (1|participant_id), 
             data = completely_merged_data_ALLyears)

summary(mixed_model1)
summary(mixed_model2)

# Calculate effect sizes
eta_squared(mixed_model1)
eta_squared(mixed_model2)
```

```{r, eval=FALSE}
completely_merged_data_ALLyears <- completely_merged_data_ALLyears %>%
  mutate(
    total_gestures_z = scale(total_gestures),
    total_pretend_episodes_z = scale(total_pretend_episodes),
    mlu_z = scale(mlu),
    prop_episodes_with_gesture_z = scale(prop_episodes_with_gesture)
  )
```

```{r, eval=FALSE}
library(lme4)

mixed_model1_scaled <- lmer(max_avg ~ groupstatus + total_gestures_z + total_pretend_episodes_z + mlu_z +
                            groupstatus:total_gestures_z + (1 | participant_id),
                            data = completely_merged_data_ALLyears,
                            control = lmerControl(optimizer = "bobyqa"))
```

```{r, eval=FALSE}
glimpse(completely_merged_data_ALLyears)
```

```{r, eval=FALSE}
completely_merged_data_ALLyears$total_gestures_z <- as.numeric(scale(completely_merged_data_ALLyears$total_gestures))
completely_merged_data_ALLyears$total_pretend_episodes_z <- as.numeric(scale(completely_merged_data_ALLyears$total_pretend_episodes))
completely_merged_data_ALLyears$mlu_z <- as.numeric(scale(completely_merged_data_ALLyears$mlu))

```

```{r, eval=FALSE}
completely_merged_data_ALLyears %>%
  select(total_gestures, total_pretend_episodes, mlu, max_avg) %>%
  cor(use = "complete.obs")
```

```{r, eval=FALSE}
model1_z <- lmer(max_avg ~ groupstatus + total_gestures_z + total_pretend_episodes_z + mlu_z + groupstatus:total_gestures_z + (1|participant_id), 
                 data = completely_merged_data_ALLyears)
summary(model1_z)

```

```{r, eval=FALSE}
model1 <- lmer(
  max_avg ~ total_gestures_z + total_pretend_episodes_z + mlu_z +
    (1 | participant_id),
  data = completely_merged_data_ALLyears,
  control = lmerControl(optimizer = "bobyqa")
)
summary(model1)
```

```{r, eval=FALSE}
# Using proportion of episodes with gestures
model3 <- lmer(
  max_avg ~ prop_episodes_with_gesture_z + mlu_z +
    (1 | participant_id),
  data = completely_merged_data_ALLyears,
  control = lmerControl(optimizer = "bobyqa")
)
summary(model3)

```

```{r, eval=FALSE}
cor(completely_merged_data_ALLyears$prop_episodes_with_gesture_z,
    completely_merged_data_ALLyears$mlu_z, use = "complete.obs")

```

```{r, eval=FALSE}
vif(lm(max_avg ~ prop_episodes_with_gesture_z + mlu_z, 
        data = completely_merged_data_ALLyears))

```

```{r, eval=FALSE}
# Boxplot for prop_episodes_with_gesture_z
boxplot(completely_merged_data_ALLyears$prop_episodes_with_gesture_z, main = "Boxplot of prop_episodes_with_gesture_z")

# Boxplot for mlu_z
boxplot(completely_merged_data_ALLyears$mlu_z, main = "Boxplot of mlu_z")

```

```{r, eval=FALSE}
# Calculate Z-scores for prop_episodes_with_gesture_z and mlu_z
z_scores <- scale(completely_merged_data_ALLyears[, c("prop_episodes_with_gesture_z", "mlu_z")])

# Identify outliers with Z-scores greater than 3 or less than -3
outliers <- which(abs(z_scores) > 3, arr.ind = TRUE)
outliers

```

```{r, eval=FALSE}
# Identify the rows
completely_merged_data_ALLyears[c(17, 48), c("participant_id", "prop_episodes_with_gesture_z", "prop_episodes_with_gesture", "max_avg")]

```

```{r, eval=FALSE}
# Install if needed
install.packages("robustlmm")
library(robustlmm)

model3_robust <- rlmer(
  max_avg ~ prop_episodes_with_gesture_z + mlu_z + (1 | participant_id),
  data = completely_merged_data_ALLyears
)

summary(model3_robust)

```

```{r, eval=FALSE}
# Exclude participants 75 and 117
cleaned_data <- completely_merged_data_ALLyears %>%
  filter(!participant_id %in% c(75, 117))

# Refit the mixed model
model3_cleaned <- lmer(
  max_avg ~ prop_episodes_with_gesture_z + mlu_z + (1 | participant_id),
  data = cleaned_data,
  control = lmerControl(optimizer = "bobyqa")
)

# View results
summary(model3_cleaned)

```

```{r, eval=FALSE}
VarCorr(model3_cleaned)

```

